#!/bin/sh

# Generate descriptor file for CANMIO-SVO modules.
# Use this script to avoid duplication and reduce maintenance.

# Note: This does not use NV37 for testing servos. Instead using the outputOnWrite flag for end positions
# which writes the corresponding end position NV, just like is done for CANMIO. Works fine.

# Used to omit trailing comma at end of lists.
ending[0]=',' # False - not end of list, add a comma.
ending[1]=''  # True  - at end of list, omit trailing comma.

cat <<EOF
{
  "comment":"Generated by $0",
  "moduleName":"CANMIO-SVO",
  "NVsetNeedsLearnMode": true,
  "nodeVariables": [
EOF

for ch in 1 2 3 4 5 6 7 8
do
    cat <<EOF
    {
      "type": "NodeVariableGroup",
      "displayTitle": "Servo $ch",
      "groupItems": [
        {
          "displayTitle": "ON end position",
          "type": "NodeVariableSlider",
          "nodeVariableIndex": $((1+$ch*4)),
          "outputOnWrite": "true"
        },
        {
          "displayTitle": "OFF end position",
          "type": "NodeVariableSlider",
          "nodeVariableIndex": $((2+$ch*4)),
          "outputOnWrite": "true"
        },
        {
          "displayTitle": "ON speed",
          "type": "NodeVariableSlider",
          "nodeVariableIndex": $((3+$ch*4)),
          "max": 7
        },
        {
          "displayTitle": "OFF speed",
          "type": "NodeVariableSlider",
          "nodeVariableIndex": $((4+$ch*4)),
          "max": 7
        },
        {
          "displayTitle": "Cut off at end position",
          "type": "NodeVariableBitSingle",
          "nodeVariableIndex": 1,
          "bit": $(($ch-1))
        },
        {
          "displayTitle": "Wait for other servos to complete",
          "type": "NodeVariableBitSingle",
          "nodeVariableIndex": 4,
          "bit": $(($ch-1))
        },
        {
          "displayTitle": "Move at startup enable",
          "type": "NodeVariableBitSingle",
          "nodeVariableIndex": 3,
          "bit": $(($ch-1))
        },
        {
          "displayTitle": "Startup position",
          "visibilityLogic": { 
            "nvBit": {"index": 3, "bit": $(($ch-1))},
            "equals": 1
          },
          "type": "NodeVariableSelect",
          "nodeVariableIndex": 2,
          "bitMask": $((1<<($ch-1))),
          "options": [
            {"value": 0, "label": "Start at saved position"},
            {"value": $((1<<($ch-1))), "label": "Start at OFF position"}
          ]
        }
      ]
    }${ending[$(($ch == 8))]}
EOF
done

cat <<EOF
  ]
}
EOF
